<!DOCTYPE html>
<html>
<head>
<style>
body {font:16px sans-serif}
canvas { border: 1px solid #E8E8E8; }
</style>
</head>
<body>

<canvas id='myCanvas' width="700" height="200"></canvas>
<br><br>
<button id=btn>Start / Stop</button>
<br><br>
<div id="jsontbl">.</div>

<script language="JavaScript">
<!--
const myFrameRate = 4; //12,24,29.97,30,60
const scale = 1;
const width = 32; //chibi width
const height = 32; //chibi height
const scaledWidth = scale * width;
const scaledHeight = scale * height;

const cycleLoop = [0, 1, 0, 2];
let currentLoopIndex = 0;
let frameCount = 0;
let currentDirection = 0;

var pTime = 0, mTime = 0, x = 0;
var ctx = myCanvas.getContext("2d");

//=================================================================
const gif1px = 'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==';
var aryImg = new Array(10); //num of characters
for(var i=0; i < aryImg.length; i++) {
	aryImg[i] = new Image();
	aryImg[i].src  = gif1px;
	aryImg[i].onload = function() {init();};
}

function init() {
	fps.start();
}

function drawFrame(frameX, frameY, canvasX, canvasY) {
	for(var i=0; i < aryImg.length; i++) {
		ctx.drawImage(	aryImg[i],
						frameX * width, frameY * height, 
						width, height,
						//canvasX, canvasY, 
						i*(32+3), 0,
						scaledWidth, scaledHeight );
	}
}

var rndImgList = ",";
function randomImgId() {
	var rnd = ((Math.round(Math.random()*100))-1) % 79; //0 to 78
	if(rnd < 0) rnd = 0;
	return rnd;
}

function loadImage() {
	for(var i=0; i < aryImg.length; i++) {
		var rndImg = randomImgId();
		while(rndImgList.indexOf(","+rndImg+",") >=0 ) {
			rndImg = randomImgId();
		}
		rndImgList += (rndImg+",");
		aryImg[i].src = "https://pgomap.github.io/chibis/chibi_"+ rndImg +".png";
	}
}
loadImage();

//=================================================================

// update canvas with some information and animation
var fps = new FpsCtrl(myFrameRate, function(e) {
	ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
	pTime = e.time;
	var x = (pTime - mTime) * 0.1;
	if (x > myCanvas.width) mTime = pTime;
	drawFrame(cycleLoop[currentLoopIndex], currentDirection, 0, 0);
	currentLoopIndex++;
	if (currentLoopIndex >= cycleLoop.length) {
		currentLoopIndex = 0;
		currentDirection ++;
	}
	currentDirection %= 4;
})

btn.onclick = function() {
	fps.isPlaying ? fps.pause() : fps.start();
};

//frame/sec control
function FpsCtrl(fps, callback) {

	var	delay = 1000 / fps,
		time = null,
		frame = -1,
		tref;

	function loop(timestamp) {
		if (time === null) time = timestamp;
		var seg = Math.floor((timestamp - time) / delay);
		if (seg > frame) {
			frame = seg;
			callback({
				time: timestamp,
				frame: frame
			})
		}
		tref = requestAnimationFrame(loop)
	}

	this.isPlaying = false;
	
	this.frameRate = function(newfps) {
		if (!arguments.length) return fps;
		fps = newfps;
		delay = 1000 / fps;
		frame = -1;
		time = null;
	};
	
	this.start = function() {
		if (!this.isPlaying) {
			this.isPlaying = true;
			tref = requestAnimationFrame(loop);
		}
	};
	
	this.pause = function() {
		if (this.isPlaying) {
			cancelAnimationFrame(tref);
			this.isPlaying = false;
			time = null;
			frame = -1;
		}
	};
}

//====================================================
var id = '1BrlwpJDJfINkfh_akFqs6XG6XrwEh0vp264QYGrcrmY';
var gid = '0';
var url = 'https://docs.google.com/spreadsheets/d/'+id+'/gviz/tq?tqx=out:json&tq&gid='+gid;

fetch(url)
  .then(response => response.text())
  .then(data => document.getElementById("jsontbl").innerHTML=myItems(data.substring(47).slice(0, -2))  
  );
function myItems(jsonString){
  var json = JSON.parse(jsonString);
  var table = '<table><tr>'
  json.table.cols.forEach(colonne => table += '<th>' + colonne.label + '</th>')
  table += '</tr>'
  json.table.rows.forEach(ligne => {
    table += '<tr>'
    ligne.c.forEach(cellule => {
        try{var valeur = cellule.f ? cellule.f : cellule.v}
        catch(e){var valeur = ''}
        table += '<td>' + valeur + '</td>'
      }
    )
    table += '</tr>'
    }
  )
  table += '</table>'
  return table
}
//====================================================
//-->
</script>

</body>
</html>


